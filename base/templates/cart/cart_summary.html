<!DOCTYPE html>
<html lang="en">
<head>
  {%load static%}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LICET Canteen Cart</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link href="6.Cart.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="stylesheet" href="{% static 'accounts/cart_summary.css' %}" >
</head>
<body>

  <nav class="sidebar" id="sidebar">
  <a href="{% url 'home' %}">Home</a>
  <a href="{% url 'cart_summary' %}">Cart</a>
  <a href="{% url 'contact' %}">Contact</a> <!-- or use mailto or a contact section -->
  </nav>

  <!-- Hamburger Menu -->
    <div class="hamburger-menu" onclick="toggleSidebar()">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>

  <!-- User Section with Dropdown -->
  <div class="user-section"> 
    <button class="user-button" onclick="toggleDropdown()">
      <img src="Images/Landing Page/User-Logo.png" alt="User Profile">
      <span class="user-info" id="userName">User Name</span>
      <i class="fas fa-chevron-down" style="margin-left: 5px; font-size: 12px;"></i>
    </button>
    
    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="dropdownMenu">
      <div class="dropdown-header">
        <div>Welcome back!</div>
      </div>
      
      <a href="#" class="dropdown-item" onclick="openProfileModal()">
        <i class="fas fa-user-edit"></i>
        <span>Update Profile</span>
      </a>
      
      <div class="dropdown-item points-section">
        <i class="fas fa-coins"></i>
        <span>Points: <strong id="userPoints">250</strong></span>
      </div>
      
      <a href="{% url 'login' %}" class="dropdown-item logout-section">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </a>
    </div>
  </div>

  <!-- Profile Update Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Update Profile</h2>
        <button class="close" onclick="closeProfileModal()">&times;</button>
      </div>
      
      <form id="profileForm">
        <!-- Profile Picture Section -->
        <div class="profile-pic-section">
          <div class="profile-pic-container">
            <img id="profilePicPreview" src="Images/Landing Page/User-Logo.png" alt="Profile Picture" class="profile-pic-preview">
            <div class="profile-pic-overlay" onclick="document.getElementById('profilePicInput').click()">
              <i class="fas fa-camera"></i>
            </div>
          </div>
          <div>
            <input type="file" id="profilePicInput" class="profile-pic-input" accept="image/*" onchange="handleProfilePicChange(event)">
            <button type="button" class="upload-btn" onclick="document.getElementById('profilePicInput').click()">
              <i class="fas fa-upload"></i> Choose Photo
            </button>
            <button type="button" class="remove-pic-btn" onclick="removeProfilePic()">
              <i class="fas fa-trash"></i> Remove
            </button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="fullName">Full Name</label>
          <input type="text" id="fullName" name="fullName" placeholder="Enter your full name">
        </div>
        
        <div class="form-group">
          <label for="yearOfStudy">Year of Study</label>
          <select id="yearOfStudy" name="yearOfStudy">
            <option value="">Select Year</option>
            <option value="1st Year">1st Year</option>
            <option value="2nd Year">2nd Year</option>
            <option value="3rd Year">3rd Year</option>
            <option value="4th Year">4th Year</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="batch">Batch</label>
          <input type="text" id="batch" name="batch" placeholder="e.g., 2021-2025">
        </div>
        
        <div class="form-group">
          <label for="department">Department</label>
          <select id="department" name="department">
            <option value="">Select Department</option>
            <option value="Computer Science">Computer Science</option>
            <option value="Electronics">Electronics</option>
            <option value="Mechanical">Mechanical</option>
            <option value="Civil">Civil</option>
            <option value="Electrical">Electrical</option>
            <option value="Information Technology">Information Technology</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="dateOfBirth">Date of Birth</label>
          <input type="date" id="dateOfBirth" name="dateOfBirth">
        </div>
        
        <button type="button" class="save-btn" onclick="saveProfile()">Save Changes</button>
      </form>
    </div>
  </div>

  <!-- Sidebar Navigation -->
  <nav class="sidebar" id="sidebar">
    <a href="#">Home</a>
    <a href="#">Menu</a>
    <a href="#">Cart</a>
    <a href="#">Contact</a>
  </nav>

  <header>
    <!-- College Logo Placeholder - Replace with your actual logo -->
    <img src="Images/Cart/licet_logo.png" alt="LICET Logo" class="college-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
    <div class="college-logo" style="display: none;">L</div>
    <h1>LICET Cafeteria</h1>
  </header>

  <nav>
    <a href="#cart">üõí Cart</a>
    <a href="#slot">üìÖ Slot</a>
    <a href="#payment">üí≥ Payment</a>
    <a href="#receipt">üßæ Receipt</a>
  </nav>

  <main>
    <section id="cart" class="active">
      <h2>Your Cart</h2>
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody id="cart-body"></tbody>
      </table>

      <div class="summary-box">
        <p><strong>Subtotal:</strong> <span>‚Çπ<span id="subtotal">0</span></span></p>
        <p><strong>Discount (5%):</strong> <span>‚Çπ<span id="discount">0</span></span></p>
        <p><strong>Total Amount:</strong> <span>‚Çπ<span id="total">0</span></span></p>
        <input type="text" id="coupon" placeholder="Enter coupon code (e.g. LICET5)" />
      </div>
    </section>

    <section id="slot">
      <h2>Select Date</h2>
      <div class="calendar-container">
        <input type="date" id="order-date">
      </div>

      <h2>Select Time Slot</h2>
      <div class="scroll-row">
        <button class="option-btn active" data-time="12:45">12:45 PM</button>
        <button class="option-btn" data-time="12:50">12:50 PM</button>
        <button class="option-btn" data-time="12:55">12:55 PM</button>
        <button class="option-btn" data-time="1:00">1:00 PM</button>
        <button class="option-btn" data-time="1:05">1:05 PM</button>
      </div>

      <h2>Order Type</h2>
      <div class="scroll-row">
        <button class="option-btn active" data-type="Dine In">üçΩÔ∏è Dine In</button>
        <button class="option-btn" data-type="Takeaway">üì¶ Takeaway</button>
      </div>
    </section>

    <section id="payment">
      <h2>Payment Method</h2>
      <div class="scroll-row">
        <!-- Payment buttons with logo placeholders -->
        <button class="payment-btn active">
          <img src="Images/Cart/google-pay-logo.png" alt="Google Pay" class="payment-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="payment-logo" style="display: none;">GP</div>
          Google Pay
        </button>
        <button class="payment-btn">
          <img src="Images/Cart/phonepe-logo.png" alt="PhonePe" class="payment-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="payment-logo" style="display: none;">PP</div>
          PhonePe
        </button>
        <button class="payment-btn">
          <img src="Images/Cart/paytm-logo.png" alt="Paytm" class="payment-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="payment-logo" style="display: none;">PTM</div>
          Paytm
        </button>
        <button class="payment-btn">
          <img src="Images/Cart/bhim-logo.png" alt="BHIM" class="payment-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="payment-logo" style="display: none;">BHIM</div>
          BHIM
        </button>
      </div>
    </section>

    <section id="receipt">
      <h2>Order Receipt</h2>
      <div class="receipt" id="receipt-content">
        <div class="receipt-header">
          <!-- College Logo in Receipt -->
          <img src="Images/Cart/licet_logo.png" alt="LICET Logo" class="receipt-college-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="receipt-college-logo" style="display: none;">L</div>
          <h3>LICET Cafeteria</h3>
          <p>Order Confirmation</p>
        </div>
        
        <div class="receipt-detail">
          <strong>Order Items:</strong>
          <span id="receipt-items">Schezwan Fried Rice, Chicken 65</span>
        </div>
        
        <div class="receipt-detail">
          <strong>Date & Time:</strong>
          <span><span class="selected-time">12:45 PM</span> on <span id="selected-date">--/--/----</span></span>
        </div>
        
        <div class="receipt-detail">
          <strong>Order Type:</strong>
          <span class="selected-type">Dine In</span>
        </div>
        
        <div class="receipt-detail">
          <strong>Order Number:</strong>
          <span id="order-number">LCT-035</span>
        </div>
        
        <div class="receipt-detail">
          <strong>Amount Paid:</strong>
          <span>‚Çπ<span id="receipt-total">0</span></span>
        </div>
        
        <div id="qrcode"></div>
        <button id="download-receipt">üì• Download Receipt</button>
      </div>
    </section>
  </main>
  <!-- Footer -->
  <footer class="footer">
    <p>&copy; 2025 LICET Cafeteria. All rights reserved.</p>
    <div class="social-links">
      <a href="#" aria-label="Facebook"><img src="Images/Landing Page/facebook.jpg" alt="Facebook"></a>
      <a href="#" aria-label="Instagram"><img src="Images/Landing Page/instagram.jpg" alt="Instagram"></a>
      <a href="#" aria-label="Twitter"><img src="Images/Landing Page/X.png" alt="Twitter"></a>
    </div>
  </footer>

  <script>
    // Toggle Sidebar
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
    }

    // Close sidebar when clicking outside
    document.addEventListener('click', function(event) {
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.querySelector('.hamburger-menu');
      
      if (!sidebar.contains(event.target) && !hamburger.contains(event.target)) {
        sidebar.classList.remove('active');
      }
    });

    // Sample cart items
    let items = JSON.parse(localStorage.getItem('cartItems')) || [];


    let selectedTime = '12:45 PM';
    let selectedType = 'Dine In';
    let selectedDate = '';

    // DOM elements
    const cartBody = document.getElementById('cart-body');
    const subtotalEl = document.getElementById('subtotal');
    const discountEl = document.getElementById('discount');
    const totalEl = document.getElementById('total');
    const couponInput = document.getElementById('coupon');
    const receiptTotal = document.getElementById('receipt-total');
    const selectedDateEl = document.getElementById('selected-date');
    const receiptItems = document.getElementById('receipt-items');

    function renderCart() {
      cartBody.innerHTML = '';
      let subtotal = 0;

      items.forEach((item, idx) => {
        const row = document.createElement('tr');
        const itemTotal = item.price * item.qty;
        subtotal += itemTotal;

        row.innerHTML = `
          <td>
            <div class="item-cell">
              <img src="${item.img}" class="food-img" alt="${item.name}">
              <span>${item.name}</span>
            </div>
          </td>
          <td><strong>‚Çπ${item.price}</strong></td>
          <td>
            <input type="number" min="1" value="${item.qty}" data-idx="${idx}" class="qty-input">
          </td>
          <td><strong>‚Çπ<span class="subtotal">${itemTotal}</span></strong></td>
        `;
        cartBody.appendChild(row);
      });

      applyDiscount(subtotal);
      updateReceiptItems();
    }

    function applyDiscount(subtotal) {
      const code = couponInput.value.trim();
      let discount = 0;
      if (code.toUpperCase() === 'LICET5') {
        discount = Math.round(subtotal * 0.05);
      }
      const total = subtotal - discount;

      subtotalEl.textContent = subtotal;
      discountEl.textContent = discount;
      totalEl.textContent = total;
      receiptTotal.textContent = total;
      
      // Update QR code with new total
      generateQRCode();
    }

    function updateReceiptItems() {
      const itemNames = items.map(item => `${item.name} (x${item.qty})`).join(', ');
      receiptItems.textContent = itemNames;
    }

    function generateQRCode() {
      const qrContainer = document.getElementById('qrcode');
      qrContainer.innerHTML = ''; // Clear existing QR code
      
      const orderData = {
        restaurant: 'LICET Cafeteria',
        items: items.map(item => `${item.name} x${item.qty}`),
        total: receiptTotal.textContent,
        date: selectedDate || new Date().toISOString().split('T')[0],
        time: selectedTime,
        type: selectedType,
        orderNumber: 'LCT-035'
      };
      
      const qrText = `LICET Cafeteria Receipt\nOrder: ${orderData.items.join(', ')}\nDate: ${orderData.date} ${orderData.time}\nType: ${orderData.type}\nTotal: ‚Çπ${orderData.total}\nOrder #: ${orderData.orderNumber}`;
      
      try {
        const qr = qrcode(0, 'M');
        qr.addData(qrText);
        qr.make();
        qrContainer.innerHTML = qr.createImgTag(4, 8);
      } catch (error) {
        console.error('QR Code generation failed:', error);
        qrContainer.innerHTML = '<div style="padding: 20px; background: #f0f0f0; border-radius: 8px; color: #666;">QR Code will be generated here</div>';
      }
    }

    // Event listeners
    cartBody.addEventListener('input', (e) => {
      if (e.target.type === 'number') {
        const idx = e.target.dataset.idx;
        const newQty = parseInt(e.target.value);
        if (newQty > 0) {
          items[idx].qty = newQty;
          renderCart();
        }
      }
    });

    couponInput.addEventListener('input', () => {
      let subtotal = 0;
      items.forEach(item => {
        subtotal += item.price * item.qty;
      });
      applyDiscount(subtotal);
    });

    document.getElementById('order-date').addEventListener('change', function() {
      selectedDate = this.value;
      selectedDateEl.textContent = this.value || '--/--/----';
      generateQRCode();
    });

    // Time slot selection
    document.querySelectorAll('.option-btn[data-time]').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.option-btn[data-time]').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        selectedTime = this.dataset.time;
        document.querySelector('.selected-time').textContent = selectedTime;
        generateQRCode();
      });
    });

    // Order type selection
    document.querySelectorAll('.option-btn[data-type]').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.option-btn[data-type]').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        selectedType = this.dataset.type;
        document.querySelector('.selected-type').textContent = selectedType;
        generateQRCode();
      });
    });

    // Payment method selection
    document.querySelectorAll('.payment-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.payment-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
      });
    });

    document.getElementById('download-receipt').addEventListener('click', () => {
      const element = document.getElementById('receipt-content');
      const opt = {
        margin: 1,
        filename: 'LICET_Receipt.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      
      html2pdf().set(opt).from(element).save().then(() => {
        alert('Receipt downloaded successfully!');
      });
    });

    // Initialize
    renderCart();
    
    // Set initial date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('order-date').value = today;
    selectedDate = today;
    selectedDateEl.textContent = today;

    // Animate sections
    const sections = document.querySelectorAll('section');
    sections.forEach((section, index) => {
      setTimeout(() => {
        section.classList.add('active');
      }, index * 200);
    });

    // Generate initial QR code
    setTimeout(generateQRCode, 500);

    // Hamburger Menu Toggle
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('active');
    }

    // User Dropdown Toggle
    function toggleDropdown() {
      const dropdown = document.getElementById('dropdownMenu');
      dropdown.classList.toggle('active');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const userSection = document.querySelector('.user-section');
      const dropdown = document.getElementById('dropdownMenu');
      
      if (!userSection.contains(event.target)) {
        dropdown.classList.remove('active');
      }
    });

    // Profile Modal Functions
    function openProfileModal() {
      document.getElementById('profileModal').style.display = 'block';
      document.getElementById('dropdownMenu').classList.remove('active');
      
      // Load existing data if available
      loadProfileData();
    }

    function closeProfileModal() {
      document.getElementById('profileModal').style.display = 'none';
    }

    function loadProfileData() {
  const userData = JSON.parse(localStorage.getItem('userData')) || {};

  document.getElementById('fullName').value = userData.fullName || '';
  document.getElementById('yearOfStudy').value = userData.yearOfStudy || '';
  document.getElementById('batch').value = userData.batch || '';
  document.getElementById('department').value = userData.department || '';
  document.getElementById('dateOfBirth').value = userData.dateOfBirth || '';

  // Load profile picture
  if (userData.profilePic) {
    document.getElementById('profilePicPreview').src = userData.profilePic;
    document.querySelector('.user-button img').src = userData.profilePic;
  }

  if (userData.fullName) {
    document.getElementById('userName').textContent = userData.fullName;
  }
}


    function handleProfilePicChange(event) {
      const file = event.target.files[0];
      if (file) {
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file.');
          return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('Please select an image smaller than 5MB.');
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const imageDataUrl = e.target.result;
          document.getElementById('profilePicPreview').src = imageDataUrl;
          
          // Store the image data temporarily
          window.tempProfilePic = imageDataUrl;
        };
        reader.readAsDataURL(file);
      }
    }

    function removeProfilePic() {
      // Reset to default profile picture
      const defaultPic = 'Images/Landing Page/User-Logo.png';
      document.getElementById('profilePicPreview').src = defaultPic;
      document.getElementById('profilePicInput').value = '';
      window.tempProfilePic = null;
    }

    function saveProfile() {
      const formData = {
        fullName: document.getElementById('fullName').value,
        yearOfStudy: document.getElementById('yearOfStudy').value,
        batch: document.getElementById('batch').value,
        department: document.getElementById('department').value,
        dateOfBirth: document.getElementById('dateOfBirth').value,
        profilePic: window.tempProfilePic || window.userData?.profilePic || 'Images/Landing Page/User-Logo.png'
      };

      // Save to memory (in a real app, this would be sent to a server)
      localStorage.setItem('userData', JSON.stringify(formData));

      
      // Update the display name
      if (formData.fullName) {
        document.getElementById('userName').textContent = formData.fullName;
      }

      // Update the user button profile picture
      if (formData.profilePic) {
        document.querySelector('.user-button img').src = formData.profilePic;
      }

      // Clear temporary profile pic data
      window.tempProfilePic = null;

      // Show success message
      alert('Profile updated successfully!');
      closeProfileModal();
    }

    function logout() {
      const confirmLogout = confirm('Are you sure you want to logout?');
      if (confirmLogout) {
        // Clear user data
        window.userData = {};
        window.tempProfilePic = null;
        
        // In a real app, you would redirect to login page
        alert('You have been logged out successfully!');
        
        // Reset display
        document.getElementById('userName').textContent = 'User Name';
        document.querySelector('.user-button img').src = 'Images/Landing Page/User-Logo.png';
        document.getElementById('dropdownMenu').classList.remove('active');
      }
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('profileModal');
      if (event.target === modal) {
        closeProfileModal();
      }
    }

    // Initialize user data storage
    window.userData = window.userData || {};
    document.addEventListener('DOMContentLoaded', () => {
  loadProfileData();
});

localStorage.removeItem('cartItems');


  </script>
</body>
</html>